<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>調布祭執行委員会POSシステム</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
</head>
<body>
    <!-- ログインモーダル -->
    <div id="login-modal" class="login-overlay">
        <div class="login-modal-content">
            <div class="login-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            </div>
            <h2 class="login-title">ログイン</h2>
            <div class="login-input-group">
                <label>学籍番号
                <input type="password" id="employee-id-input" placeholder="スキャンまたはタッチで入力">
                </label>
            </div>
            <button id="login-submit-button" class="login-submit-btn">ログイン</button>
        </div>
    </div>

    <!-- メインPOSコンテナ -->
    <div class="modern-pos-container">
        <!-- 左側：カート表示エリア -->
        <div class="cart-display-area">
            <div class="pos-header">
                <span class="header-title">調布祭POSレジ</span>
                <span id="current-time" class="header-time"></span>
                <div class="header-status">
                    <span>[レジNo.1]</span>
                    <span class="help-icon">?</span>
                </div>
            </div>
            <div id="pos-main-alert" class="pos-main-alert">商品を登録してください。よろしければ、会計してください。</div>
            <div class="cart-content-wrapper">
                <div class="cart-table-container">
                    <table id="cart-table"><tbody id="cart-items-tbody"></tbody></table>
                </div>
                <div id="discount-display-area" class="discount-display hidden">
                    <span>値引:</span>
                    <span id="discount-amount-display"></span>
                    <button id="cancel-discount-btn">×</button>
                </div>
            </div>
            <div class="cart-total-area">
                <div class="total-box">
                    <div class="total-label">合　計</div>
                    <div class="total-amount-display">¥ <span id="total-amount">0</span></div>
                </div>
            </div>
            <!-- ★★★ 新しい決済ボタンエリア ★★★ -->
            <div class="pos-checkout-area new-layout">
                <button class="checkout-btn new" data-method="credit_card">
                    <img src="../Chofusai-POS-shikkou/img/icon_Credit.png" alt="Credit Card"><span>クレジット</span>
                </button>
                <button class="checkout-btn new" data-method="e_money">
                    <img src="../Chofusai-POS-shikkou/img/icon_EMoney.png" alt="E-Money"><span>電子マネー</span>
                </button>
                <button class="checkout-btn new" data-method="ic_card">
                    <img src="../Chofusai-POS-shikkou/img/icon_IC.png" alt="IC Card"><span>交通系IC</span>
                </button>
                <button class="checkout-btn new" data-method="qr_code">
                    <img src="../Chofusai-POS-shikkou/img/icon_QR.png" alt="QR Code"><span>QRコード</span>
                </button>
                <button class="checkout-btn new cash" data-method="cash">
                    <img src="../Chofusai-POS-shikkou/img/icon_Cash.png" alt="Cash"><span>現金</span>
                </button>
            </div>
        </div> <!-- ★★★★★ ここが正しい閉じタグの位置 ★★★★★ -->

        <!-- 右側：機能パネルエリア -->
        <div class="function-panel-area">
            <div class="pos-tabs">
                <button class="tab-button active" data-tab="tab-products">1.商品</button>
                <button class="tab-button" data-tab="tab-services">2.サービス</button>
                <button class="tab-button" data-tab="tab-operations">3.業務</button>
            </div>
            <div class="tab-content-container">
                <div id="tab-products" class="tab-content active"><div id="product-list" class="item-grid"></div></div>
                <div id="tab-services" class="tab-content"><div id="service-list" class="item-grid"></div></div>
                <div id="tab-operations" class="tab-content"><div id="operation-list" class="item-grid"></div></div>
            </div>
        </div>
    </div>
    
    <!-- フッターアイコンバー -->
    <footer class="pos-footer">
        <button class="footer-btn"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"></path></svg><span>呼び出し</span></button>
        <button class="footer-btn" id="footer-cancel-btn"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg><span>中止</span></button>
        <button class="footer-btn"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg><span>保留</span></button>
        <button class="footer-btn"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"></path></svg><span>手入力入金</span></button>
        <button class="footer-btn" id="footer-alert-btn"><div class="alert-badge-wrapper"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"></path></svg><span class="alert-badge hidden">0</span></div><span>アラートリスト</span></button>
        <button class="footer-btn" id="footer-logout-btn"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"></path></svg><span>ログアウト</span></button>
    </footer>

    <!-- 会計確認モーダル -->
    <div id="payment-confirm-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal-button">✕</span>
            <h4>会計確認</h4>
            <p>合計金額: <span id="modal-total-amount">0</span> 円</p>
            <div class="modal-payment-input">
                <label for="modal-amount-received">お預かり金額:</label>
                <input type="number" id="modal-amount-received" placeholder="0" readonly>
                <span>円</span>
            </div>
            <div id="keypad-container" class="keypad"></div>
            <p id="modal-change-display">お釣り: <span id="modal-change-amount">0</span> 円</p>
            <div class="modal-btn-area">
                <button id="cancel-payment-button" class="cancel-btn">キャンセル</button>
                <button id="confirm-payment-button" class="confirm-btn">支払いを確定する</button>
            </div>
        </div>
    </div>
    <!-- 販売数確認モーダル -->
    <div id="sales-stats-modal" class="modal hidden">
        <div class="modal-content wide">
            <span class="close-modal-button">✕</span>
            <h4>販売数確認</h4>
            <div class="sales-stats-content">
                <div class="chart-container">
                    <canvas id="sales-chart"></canvas>
                </div>
                <div id="sales-by-item-list" class="sales-list"></div>
            </div>
        </div>
    </div>
    <!-- 値引きモーダル -->
    <div id="discount-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal-button">✕</span>
            <h4>値引き</h4>
            <div class="modal-input-group">
                <label for="discount-amount-input">値引き金額:</label>
                <input type="number" id="discount-amount-input" placeholder="金額を入力">
                <span>円</span>
            </div>
            <button id="apply-discount-btn" class="confirm-btn full-width">値引きを適用</button>
        </div>
    </div>
    <!-- 売上外入金モーダル -->
    <div id="donation-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal-button">✕</span>
            <h4>売上外入金 (寄付)</h4>
            <div class="modal-input-group">
                <label for="donator-name-input">寄付者名:</label>
                <input type="text" id="donator-name-input" placeholder="氏名を入力">
            </div>
            <div class="modal-input-group">
                <label for="donation-amount-input">寄付金額:</label>
                <input type="number" id="donation-amount-input" placeholder="金額を入力">
                <span>円</span>
            </div>
            <button id="confirm-donation-btn" class="confirm-btn full-width">登録する</button>
        </div>
    </div>
    <!-- レジ点検モーダル -->
    <div id="cash-check-modal" class="modal hidden">
        <div class="modal-content wide">
            <span class="close-modal-button">✕</span>
            <h4>レジ点検</h4>
            <div id="cash-check-content" class="cash-check-grid"></div>
            <div class="cash-check-summary">
                <p>理論残高: <span id="theoretical-balance">0</span> 円</p>
                <p>実残高: <span id="actual-balance">0</span> 円</p>
                <p class="balance-diff">過不足: <span id="balance-difference">0</span> 円</p>
            </div>
            <button id="complete-cash-check-btn" class="confirm-btn full-width">点検完了</button>
        </div>
    </div>
    <!-- アラートリストモーダル -->
    <div id="alert-list-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal-button">✕</span>
            <h4>アラートリスト</h4>
            <ul id="alert-list-ul"></ul>
        </div>
    </div>
    <!-- ★★★ 決済方法選択モーダル ★★★ -->
    <div id="payment-method-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal-button">✕</span>
            <h4>決済方法を選択</h4>
            <div class="method-selection-grid">
                <button class="method-btn" data-method="credit_card">
                    <svg><!-- クレジットカードのアイコン --><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"></path></svg>
                    <span>クレジットカード</span>
                </button>
                <button class="method-btn" data-method="e_money">
                    <svg><!-- 電子マネーのアイコン --><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                    <span>電子マネー</span>
                </button>
                <button class="method-btn" data-method="qr_code">
                    <svg><!-- QRコードのアイコン --><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-6 8h8v-8h-8v8zm2-6h4v4h-4v-4z"></path></svg>
                    <span>QRコード</span>
                </button>
            </div>
            <button id="cancel-method-selection" class="cancel-btn full-width">キャンセル</button>
        </div>
    </div>
    <!-- ★★★ キャッシュレス決済用モーダル ★★★ -->
    <div id="cashless-payment-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal-button">✕</span>
            <h4>キャッシュレス会計確認</h4>
            <div class="cashless-summary">
                <p>会計金額: <span id="cashless-modal-total-amount">0.00</span> 円</p>
                <hr>
                <p class="fee-info">決済手数料: <span id="cashless-modal-fee">0</span> 円</p>
                <p class="final-amount">お受取額 (手数料引き後): <span id="cashless-modal-net-amount">0</span> 円</p>
            </div>
            <p class="modal-note">スマートフォン等で<strong id="cashless-charge-amount">0 </strong>円を決済し、完了したら下のボタンを押してください。</p>
            <div class="modal-btn-area">
                <button id="cancel-cashless-payment-button" class="cancel-btn">キャンセル</button>
                <button id="confirm-cashless-payment-button" class="confirm-btn">支払いを確定する</button>
            </div>
        </div>
    </div>

    <!-- スクリプト読み込み -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/pos-script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });
            const timeSpan = document.getElementById('current-time');
            function updateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const date = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                if(timeSpan) timeSpan.textContent = `${year}/${month}/${date} ${hours}:${minutes}`;
            }
            updateTime();
            setInterval(updateTime, 1000 * 30);
        });
    </script>
</body>
</html>