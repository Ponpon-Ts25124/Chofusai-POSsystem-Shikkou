<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POSレジ - お客様画面</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="POSレジ">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        html, body { overflow: hidden; }
        
        /* お品書きエリアのスタイル */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
            height: flex;
            box-sizing: border-box;
        }
        .menu-item {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        .menu-item img {
            width: 100%;
            height: 100%;
            object-fit: scale-down;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .menu-item h3 { margin: 0 0 5px 0; font-size: 1.4em; }
        .menu-item .price { font-size: 1.2em; color: #e63946; font-weight: bold; }
        
        /* 売り切れ表示 */
        .menu-item.sold-out { opacity: 0.6; }
        .sold-out-badge {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            font-size: 2em;
            font-weight: bold;
            padding: 10px 30px;
            border-radius: 10px;
            border: 3px solid white;
            z-index: 10;
        }

        /* カート等のスタイル */
        .customer-cart-item { display: flex; font-size: 1.5em; margin-bottom: 15px; }
        .customer-cart-item .name { flex-grow: 1; }
        .customer-cart-item .qty { width: 100px; text-align: right; }
        .customer-cart-item .subtotal { width: 150px; text-align: right; font-weight: bold; }
        #qrcode { display: inline-block; margin: 20px 0; background-color: #fff; padding: 15px; border-radius: 8px; }
        #qrcode img { display: block; margin: auto; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左側: 動的お品書き -->
        <div class="left-pane" style="background-color: #fff3e0;">
            <div class="menu-grid" id="menu-grid">
                <!-- 商品カードがここに生成されます -->
            </div>
        </div>
        <!-- 右側: カート -->
        <div class="right-pane">
            <div class="cart-container">
                <div class="cart-header">ご注文内容</div>
                <div class="cart-items" id="cart-items"></div>
                <div class="cart-footer">
                    <div class="total-row" style="font-size: 2.5em;">
                        <span>合計</span><span id="total-amount">¥0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="paypay-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h2>PayPayでお支払い</h2>
            <p>合計金額: <strong id="paypay-total">¥0</strong></p>
            <div id="qrcode"></div>
            <p>支払い後、画面を店員にお見せください</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.addEventListener('touchmove', function(event) { event.preventDefault(); }, { passive: false });
        
        const menuGrid = document.getElementById('menu-grid');
        const cartItemsContainer = document.getElementById('cart-items');
        const totalAmountEl = document.getElementById('total-amount');
        const paypayModal = document.getElementById('paypay-modal');
        const paypayTotalEl = document.getElementById('paypay-total');
        const qrcodeContainer = document.getElementById('qrcode');
        let qrcode = null;

        let products = [], bundleDeals = [], currentCart = {};

        // --- データ監視 ---
        db.collection('products').orderBy('sortOrder').onSnapshot(snapshot => {
            products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMenu(); // お品書きを再描画
            renderCustomerCart(currentCart);
        });

        db.collection('bundleDeals').where('isActive', '==', true).orderBy('priority', 'desc').onSnapshot(snapshot => {
            bundleDeals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCustomerCart(currentCart);
        });

        db.collection('currentOrder').doc('main_register').onSnapshot(doc => {
            currentCart = doc.data()?.items || {};
            renderCustomerCart(currentCart);
        });

        // --- 動的お品書き描画 ---
        function renderMenu() {
            menuGrid.innerHTML = '';
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = `menu-item ${product.isSoldOut ? 'sold-out' : ''}`;
                
                const imageUrl = product.imagePath || 'https://via.placeholder.com/150';
                const soldOutBadge = product.isSoldOut ? '<div class="sold-out-badge">SOLD OUT</div>' : '';

                card.innerHTML = `
                    ${soldOutBadge}
                    <img src="${imageUrl}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <div class="price">¥${product.price.toLocaleString()}</div>
                `;
                menuGrid.appendChild(card);
            });
        }

        // --- 割引計算・カート描画・PayPay ---
        function applyBundleDiscounts(cart) {
            let originalTotal = 0, finalTotal = 0, discountAmount = 0;
            const cartItemsFlat = [];
            for (const productId in cart) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    originalTotal += (product.price - (product.discount || 0)) * cart[productId];
                    for (let i = 0; i < cart[productId]; i++) cartItemsFlat.push(productId);
                }
            }
            for (const deal of bundleDeals) {
                const eligibleItems = cartItemsFlat.filter(id => deal.eligibleProductIds.includes(id));
                while (eligibleItems.length >= deal.requiredCount) {
                    finalTotal += deal.bundlePrice;
                    let itemsToRemove = deal.requiredCount;
                    for (let i = cartItemsFlat.length - 1; i >= 0; i--) {
                        if (itemsToRemove > 0 && deal.eligibleProductIds.includes(cartItemsFlat[i])) {
                            const indexInEligible = eligibleItems.indexOf(cartItemsFlat[i]);
                            if (indexInEligible > -1) eligibleItems.splice(indexInEligible, 1);
                            cartItemsFlat.splice(i, 1);
                            itemsToRemove--;
                        }
                    }
                }
            }
            cartItemsFlat.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product) finalTotal += (product.price - (product.discount || 0));
            });
            discountAmount = originalTotal - finalTotal;
            return { finalTotal, discountAmount };
        }
        
        function renderCustomerCart(cart) {
            cartItemsContainer.innerHTML = '';
            if (products.length === 0) return;
            if (Object.keys(cart).length === 0) {
                cartItemsContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">ご注文をお待ちしております。</p>';
                totalAmountEl.textContent = '¥0';
                return;
            }
            const { finalTotal, discountAmount } = applyBundleDiscounts(cart);
            Object.keys(cart).forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (!product) return;
                const quantity = cart[productId];
                const subtotal = (product.price - (product.discount || 0)) * quantity;
                const itemEl = document.createElement('div');
                itemEl.className = 'customer-cart-item';
                itemEl.innerHTML = `<span class="name">${product.name}</span><span class="qty">${quantity} 点</span><span class="subtotal">¥${subtotal.toLocaleString()}</span>`;
                cartItemsContainer.appendChild(itemEl);
            });
            if (discountAmount > 0) {
                const discountEl = document.createElement('div');
                discountEl.className = 'customer-cart-item';
                discountEl.innerHTML = `<span class="name" style="color: #dc3545; font-weight: bold;">セット割引</span><span class="subtotal" style="color: #dc3545;">- ¥${discountAmount.toLocaleString()}</span>`;
                cartItemsContainer.appendChild(discountEl);
            }
            totalAmountEl.textContent = `¥${finalTotal.toLocaleString()}`;
        }

        db.collection('paymentInstructions').doc('main_customer_display').onSnapshot(doc => {
            const instruction = doc.data();
            if (instruction && instruction.show) {
                const amount = instruction.amount;
                const paymentUrl = `https://chofusai2025.moservice.net/pay/7?amount=${amount}`;
                paypayTotalEl.textContent = `¥${amount.toLocaleString()}`;
                qrcodeContainer.innerHTML = '';
                qrcode = new QRCode(qrcodeContainer, {
                    text: paymentUrl,
                    width: 256,
                    height: 256,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                paypayModal.style.display = 'flex';
            } else {
                paypayModal.style.display = 'none';
                if (qrcode) { qrcode.clear(); qrcodeContainer.innerHTML = ''; }
            }
        });
    });
    </script>
</body>
</html>