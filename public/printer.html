<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>印刷監視ページ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        #status { font-size: 1.5em; font-weight: bold; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .status-waiting { background-color: #e9ecef; color: #495057; }
        .status-printing { background-color: #fff3cd; color: #856404; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        h2 { border-left: 5px solid #6c757d; padding-left: 10px; }
        .logs-container { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa; border-radius: 4px; }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.9em; }
        .log-entry:last-child { border-bottom: none; }
        .success { color: #155724; }
        .error { color: #721c24; font-weight: bold; }
        .info { color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>プリンター監視中...</h1>
        <p><strong>このページは絶対に閉じないでください。</strong><br>iPadからの印刷指示を待っています。</p>
        <div id="status" class="status-waiting">ステータス: 待機中</div>
        <h2>ログ</h2>
        <div class="logs-container" id="logs"></div>
    </div>

    <!-- 印刷用の非表示iframe -->
    <iframe id="print-frame" style="display: none; width: 0; height: 0;"></iframe>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const printFrame = document.getElementById('print-frame');
        let isPrinting = false; // 印刷中の多重実行を防ぐフラグ

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = `[${new Date().toLocaleTimeString('ja-JP')}]`;
            entry.textContent = `${timestamp} ${message}`;
            logsEl.insertBefore(entry, logsEl.firstChild);
            // ログが多すぎたら古いものを削除
            if (logsEl.childElementCount > 100) {
                logsEl.removeChild(logsEl.lastChild);
            }
        }

        function setStatus(message, type = 'waiting') {
            statusEl.textContent = `ステータス: ${message}`;
            statusEl.className = `status-${type}`;
        }

        function printReceipt(receiptHTML, callback) {
            const frameDoc = printFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(receiptHTML);
            frameDoc.close();
            
            setTimeout(() => {
                try {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                    log('印刷ダイアログ（またはサイレント印刷）を呼び出しました。', 'success');
                    callback(null); // 成功を通知
                } catch (e) {
                    log(`印刷呼び出しでエラーが発生: ${e.message}`, 'error');
                    callback(e); // 失敗を通知
                }
            }, 500);
        }

        function startListening() {
            log('印刷キューの監視を開始します...');
            db.collection("printQueue").orderBy("createdAt", "asc").limit(1)
                .onSnapshot(snapshot => {
                    if (isPrinting) {
                        return; // 印刷中は何もしない
                    }
                    if (snapshot.empty) {
                        setStatus('待機中', 'waiting');
                        return;
                    }
                    
                    isPrinting = true; // 印刷処理を開始
                    const doc = snapshot.docs[0];
                    const printJob = doc.data();

                    setStatus(`印刷ジョブ #${printJob.orderNumber} を処理中...`, 'printing');
                    log(`印刷ジョブ #${printJob.orderNumber} を受信しました。`);

                    printReceipt(printJob.receiptHTML, (error) => {
                        if (error) {
                            log(`ジョブ #${printJob.orderNumber} の印刷に失敗しました。ジョブは削除されません。`, 'error');
                            isPrinting = false; // フラグをリセットして次の試行を可能にする
                            return;
                        }

                        // 印刷が成功したら、ジョブをキューから削除
                        doc.ref.delete().then(() => {
                            log(`ジョブ #${printJob.orderNumber} を正常に削除しました。`, 'success');
                        }).catch(deleteError => {
                            log(`ジョブ #${printJob.orderNumber} の削除に失敗しました: ${deleteError}`, 'error');
                        }).finally(() => {
                            isPrinting = false; // 処理が完了したらフラグをリセット
                        });
                    });
                }, error => {
                    log(`監視中にFirestoreエラーが発生: ${error}`, 'error');
                    setStatus(`監視エラー`, 'error');
                });
        }

        // 初期化
        setStatus('初期化中...');
        startListening();
    });
    </script>
</body>
</html>