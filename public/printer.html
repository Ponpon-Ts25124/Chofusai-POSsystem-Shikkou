<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>印刷監視ページ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        #status { font-size: 1.5em; font-weight: bold; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .status-waiting { background-color: #e9ecef; color: #495057; }
        .status-printing { background-color: #fff3cd; color: #856404; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        h2 { border-left: 5px solid #6c757d; padding-left: 10px; }
        .logs-container { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa; border-radius: 4px; }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.9em; }
        .log-entry:last-child { border-bottom: none; }
        .success { color: #155724; }
        .error { color: #721c24; font-weight: bold; }
        .info { color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>プリンター監視中...</h1>
        <p><strong>このページは絶対に閉じないでください。</strong><br>iPadからの印刷指示を待っています。</p>
        <div id="status" class="status-waiting">ステータス: 待機中</div>
        <h2>ログ</h2>
        <div class="logs-container" id="logs"></div>
    </div>
    <iframe id="print-frame" style="display: none; width: 0; height: 0;"></iframe>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const printFrame = document.getElementById('print-frame');
        let isPrinting = false;

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = `[${new Date().toLocaleTimeString('ja-JP')}]`;
            entry.textContent = `${timestamp} ${message}`;
            logsEl.insertBefore(entry, logsEl.firstChild);
            if (logsEl.childElementCount > 100) { logsEl.removeChild(logsEl.lastChild); }
        }

        function setStatus(message, type = 'waiting') {
            statusEl.textContent = `ステータス: ${message}`;
            statusEl.className = `status-${type}`;
        }

        function print(htmlContent, callback) {
            const frameDoc = printFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(htmlContent);
            frameDoc.close();
            
            setTimeout(() => {
                try {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                    callback(null);
                } catch (e) {
                    callback(e);
                }
            }, 500);
        }

        function startListening() {
            log('印刷キューの監視を開始します...');
            db.collection("printQueue").orderBy("createdAt", "asc").limit(1)
                .onSnapshot(snapshot => {
                    if (isPrinting || snapshot.empty) {
                        if(snapshot.empty) setStatus('待機中', 'waiting');
                        return;
                    }
                    
                    isPrinting = true;
                    const doc = snapshot.docs[0];
                    const printJob = doc.data();

                    setStatus(`印刷ジョブ #${printJob.orderNumber} を処理中...`, 'printing');
                    log(`印刷ジョブ #${printJob.orderNumber} (レシート) を受信。`);

                    print(printJob.receiptHTML, (receiptError) => {
                        if (receiptError) {
                            log(`レシート印刷失敗: ${receiptError.message}`, 'error');
                            // エラーでもフラグをリセットして次に進む
                            setTimeout(() => { isPrinting = false; }, 3000);
                            return;
                        }
                        log('レシート印刷コマンド送信完了。', 'success');

                        // 店舗控え用のHTMLを生成
                        const stubHTML = createStubHTML(printJob);
                        log(`店舗控え #${printJob.orderNumber} の印刷を開始。`);

                        // 控えを印刷 (レシート印刷の完了を待たずに実行)
                        setTimeout(() => {
                            print(stubHTML, (stubError) => {
                                if (stubError) {
                                    log(`店舗控え印刷失敗: ${stubError.message}`, 'error');
                                } else {
                                    log('店舗控え印刷コマンド送信完了。', 'success');
                                }
                                // すべての印刷が終わったらジョブを削除
                                doc.ref.delete().finally(() => {
                                    setTimeout(() => { isPrinting = false; }, 3000);
                                });
                            });
                        }, 2000); // レシートと控えの印刷が重ならないように少し待つ
                    });
                }, error => {
                    log(`監視エラー: ${error}`, 'error');
                    setStatus(`監視エラー`, 'error');
                });
        }

        function createStubHTML(printJob) {
            let itemsText = '';
            if(printJob.items && printJob.items.forEach) {
                printJob.items.forEach(item => {
                    itemsText += `<p class="item">${item.name} x ${item.quantity}</p>`;
                });
            }
            return `
                <!DOCTYPE html><html><head><style>
                    @page { margin: 0; size: 50mm auto; }
                    body { font-family: 'MS Gothic', monospace; margin: 0; padding: 0; color: #000; width: 50mm; font-size: 14pt; }
                    .stub-container { padding: 5mm 3mm; box-sizing: border-box; text-align: center; }
                    .title { font-size: 16pt; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 2mm; margin-bottom: 3mm;}
                    .order-number { font-size: 4em; font-weight: bold; margin: 2mm 0; }
                    .item { margin: 1mm 0; font-size: 12pt; }
                </style></head><body><div class="stub-container">
                    <div class="title">店舗控え</div>
                    <div class="order-number">${printJob.orderNumber}</div>
                    <div class="items-list">${itemsText}</div>
                </div></body></html>
            `;
        }
        
        setStatus('初期化中...');
        startListening();
    });
    </script>
</body>
</html>