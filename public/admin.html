<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>管理画面</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="POSレジ">
    <link rel="stylesheet" href="style.css">
    <!-- Chart.jsライブラリを読み込む -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ↓↓↓↓ この3行を一番上に追加してください ↓↓↓↓ */
        html, body { overflow: auto !important;}
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #555; }
        .card .amount { font-size: 2em; font-weight: bold; }
        .charts-container { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 30px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <span>管理画面 - 売上分析</span>
            <button id="logout-btn">ログアウト</button>
        </div>
        <div style="padding: 20px;">
            <!-- サマリーカード -->
            <div class="summary-cards">
                <div class="card">
                    <h3>総売上</h3>
                    <div class="amount" id="summary-total-sales">¥0</div>
                </div>
                <div class="card">
                    <h3>総利益</h3>
                    <div class="amount" id="summary-total-profit">¥0</div>
                </div>
                <div class="card">
                    <h3>利益率</h3>
                    <div class="amount" id="summary-profit-rate">0%</div>
                </div>
            </div>

            <!-- グラフ表示エリア -->
            <div class="charts-container">
                <div class="card">
                    <h3>時間帯別 売上</h3>
                    <div class="chart-wrapper" style="position: relative; height:400px; width:100%">
                        <canvas id="sales-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 詳細テーブル -->
            <h2>決済方法別 詳細</h2>
            <table border="1" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 8px;">決済方法</th>
                        <th style="padding: 8px;">売上</th>
                        <th style="padding: 8px;">利益</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 8px;">現金</td>
                        <td style="padding: 8px; text-align: right;" id="detail-cash-sales">¥0</td>
                        <td style="padding: 8px; text-align: right;" id="detail-cash-profit">¥0</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">キャッシュレス決済</td>
                        <td style="padding: 8px; text-align: right;" id="detail-paypay-sales">¥0</td>
                        <td style="padding: 8px; text-align: right;" id="detail-paypay-profit">¥0</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold; background-color: #f2f2f2;">
                        <td style="padding: 8px;">合計</td>
                        <td style="padding: 8px; text-align: right;" id="detail-total-sales">¥0</td>
                        <td style="padding: 8px; text-align: right;" id="detail-total-profit">¥0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

            <!-- セット割引管理セクション (ここからが新しい部分) -->
            <fieldset style="margin-top: 30px;">
                <legend><h2>セット割引 管理</h2></legend>
                <div class="card">
                    <h3>新しい割引ルールを作成</h3>
                    <input type="hidden" id="deal-id">
                    <div class="deal-form-grid">
                        <input type="text" id="deal-name" placeholder="割引名 (例: 3本セット割引)">
                        <input type="number" id="deal-priority" placeholder="優先度 (数字が大きいほど優先)">
                        <input type="number" id="deal-required-count" placeholder="必要本数 (例: 3)">
                        <input type="number" id="deal-bundle-price" placeholder="セット価格 (例: 500)">
                    </div>
                    <h4>対象商品を選択</h4>
                    <div class="product-checkboxes" id="product-checkboxes"></div>
                    <label style="margin-top:15px; display:inline-block;"><input type="checkbox" id="deal-is-active" checked> この割引を有効にする</label>
                    <div style="margin-top: 20px;">
                        <button id="save-deal-btn">保存</button>
                        <button id="clear-form-btn" style="background-color: #6c757d;">クリア</button>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h3>既存の割引ルール</h3>
                    <div id="existing-deals"></div>
                </div>
            </fieldset>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 変数定義 ---
        const logoutBtn = document.getElementById('logout-btn');
        let salesChartInstance = null;
        let allProducts = []; // 商品リストを保持
        const dealIdInput = document.getElementById('deal-id');
        const dealNameInput = document.getElementById('deal-name');
        const dealPriorityInput = document.getElementById('deal-priority');
        const dealRequiredCountInput = document.getElementById('deal-required-count');
        const dealBundlePriceInput = document.getElementById('deal-bundle-price');
        const productCheckboxesContainer = document.getElementById('product-checkboxes');
        const dealIsActiveCheckbox = document.getElementById('deal-is-active');
        const saveDealBtn = document.getElementById('save-deal-btn');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const existingDealsContainer = document.getElementById('existing-deals');

        // --- 認証と初期読み込み ---
        auth.onAuthStateChanged(user => {
            if (user) {
                initializeChart();
                loadSalesData();
                loadProductsAndDeals(); // ★割引管理用のデータも読み込む
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- イベントリスナー ---
        logoutBtn.addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
        saveDealBtn.addEventListener('click', saveBundleDeal);
        clearFormBtn.addEventListener('click', clearDealForm);

        // --- 割引管理機能 ---
        async function loadProductsAndDeals() {
            // 商品一覧を取得してチェックボックスを生成
            const productsSnapshot = await db.collection('products').orderBy('sortOrder').get();
            allProducts = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            productCheckboxesContainer.innerHTML = '';
            allProducts.forEach(product => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.innerHTML = `<input type="checkbox" class="product-checkbox" value="${product.id}"> ${product.name}`;
                productCheckboxesContainer.appendChild(label);
            });

            // 既存の割引ルールを監視
            db.collection('bundleDeals').orderBy('priority', 'desc').onSnapshot(snapshot => {
                existingDealsContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const deal = { id: doc.id, ...doc.data() };
                    const dealCard = document.createElement('div');
                    dealCard.className = 'deal-card';
                    const eligibleProductNames = deal.eligibleProductIds.map(id => allProducts.find(p => p.id === id)?.name || '不明な商品').join(', ');
                    
                    dealCard.innerHTML = `
                        <h4>${deal.dealName} (${deal.isActive ? '有効' : '無効'})</h4>
                        <p>内容: ${deal.requiredCount}個で ${deal.bundlePrice}円 (優先度: ${deal.priority})</p>
                        <p>対象商品: ${eligibleProductNames}</p>
                        <button data-id="${deal.id}" class="edit-deal-btn">編集</button>
                        <button data-id="${deal.id}" class="delete-deal-btn" style="background-color:#dc3545;">削除</button>
                    `;
                    existingDealsContainer.appendChild(dealCard);
                });
                // 編集・削除ボタンにイベントリスナーを設定
                document.querySelectorAll('.edit-deal-btn').forEach(btn => btn.addEventListener('click', (e) => loadDealIntoForm(e.target.dataset.id)));
                document.querySelectorAll('.delete-deal-btn').forEach(btn => btn.addEventListener('click', (e) => deleteBundleDeal(e.target.dataset.id)));
            });
        }

        function clearDealForm() {
            dealIdInput.value = '';
            dealNameInput.value = '';
            dealPriorityInput.value = '';
            dealRequiredCountInput.value = '';
            dealBundlePriceInput.value = '';
            dealIsActiveCheckbox.checked = true;
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
        }
        
        async function loadDealIntoForm(id) {
            const dealDoc = await db.collection('bundleDeals').doc(id).get();
            const deal = dealDoc.data();
            dealIdInput.value = id;
            dealNameInput.value = deal.dealName;
            dealPriorityInput.value = deal.priority;
            dealRequiredCountInput.value = deal.requiredCount;
            dealBundlePriceInput.value = deal.bundlePrice;
            dealIsActiveCheckbox.checked = deal.isActive;
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = deal.eligibleProductIds.includes(cb.value);
            });
        }

        async function saveBundleDeal() {
            const eligibleProductIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            if (!dealNameInput.value || eligibleProductIds.length === 0) {
                alert('割引名と対象商品を1つ以上選択してください。');
                return;
            }
            const dealData = {
                dealName: dealNameInput.value,
                priority: Number(dealPriorityInput.value) || 0,
                requiredCount: Number(dealRequiredCountInput.value),
                bundlePrice: Number(dealBundlePriceInput.value),
                eligibleProductIds: eligibleProductIds,
                isActive: dealIsActiveCheckbox.checked,
            };

            const id = dealIdInput.value;
            if (id) { // IDがあれば更新
                await db.collection('bundleDeals').doc(id).set(dealData, { merge: true });
            } else { // IDがなければ新規作成
                await db.collection('bundleDeals').add(dealData);
            }
            alert('割引ルールを保存しました。');
            clearDealForm();
        }

        async function deleteBundleDeal(id) {
            if (confirm('本当にこの割引ルールを削除しますか？')) {
                await db.collection('bundleDeals').doc(id).delete();
                alert('削除しました。');
            }
        }
        
        function initializeChart() {
            const ctx = document.getElementById('sales-chart').getContext('2d');
            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [], // 最初は空
                    datasets: [
                        {
                            label: '現金 売上',
                            data: [], // 最初は空
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'キャッシュレス決済 売上',
                            data: [], // 最初は空
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500 // 更新時のアニメーションを少しつける
                    }
                }
            });
        }
        
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★★★ renderSalesChart関数を、データ更新方式に変更 ★★★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        /**
         * グラフのデータを更新するための関数
         * @param {object} hourlyData - 時間帯別のデータ
         */
        function renderSalesChart(hourlyData) {
            if (!salesChartInstance) return; // グラフが初期化されていなければ何もしない

            const sortedHours = Object.keys(hourlyData).sort();

            const labels = sortedHours.map(hour => `${hour}時`);
            const cashSalesData = sortedHours.map(hour => hourlyData[hour].cashSales || 0);
            const paypaySalesData = sortedHours.map(hour => hourlyData[hour].paypaySales || 0);

            // データを更新
            salesChartInstance.data.labels = labels;
            salesChartInstance.data.datasets[0].data = cashSalesData;
            salesChartInstance.data.datasets[1].data = paypaySalesData;
            
            // グラフを再描画
            salesChartInstance.update();
        }

        // --- ここから下のロジックはほぼ同じ ---

        auth.onAuthStateChanged(user => {
            if (user) {
                initializeChart(); // 最初にグラフの器を準備する
                loadSalesData();
            } else {
                window.location.href = 'login.html';
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => { window.location.href = 'login.html'; });
        });

        function getTodayDateId() {
            const now = new Date();
            const jstOffset = 9 * 60;
            const jstDate = new Date(now.getTime() + (jstOffset + now.getTimezoneOffset()) * 60000);
            const yyyy = jstDate.getFullYear();
            const mm = String(jstDate.getMonth() + 1).padStart(2, "0");
            const dd = String(jstDate.getDate()).padStart(2, "0");
            return `${yyyy}-${mm}-${dd}`;
        }

        function loadSalesData() {
            const todayId = getTodayDateId();
            const summaryRef = db.collection("salesSummaries").doc(todayId);

            summaryRef.onSnapshot(doc => {
                const data = doc.exists ? doc.data() : {};
                updateDashboard(data);
            });
        }
        
        function updateDashboard(data) {
            const totalSales = data.totalSales || 0;
            const totalProfit = data.totalProfit || 0;
            const cashSales = data.cashSales || 0;
            const cashProfit = data.cashProfit || 0;
            const paypaySales = data.paypaySales || 0;
            const paypayProfit = data.paypayProfit || 0;
            const profitRate = totalSales > 0 ? ((totalProfit / totalSales) * 100).toFixed(1) : 0;
            
            document.getElementById('summary-total-sales').textContent = `¥${totalSales.toLocaleString()}`;
            document.getElementById('summary-total-profit').textContent = `¥${totalProfit.toLocaleString()}`;
            document.getElementById('summary-profit-rate').textContent = `${profitRate}%`;

            document.getElementById('detail-cash-sales').textContent = `¥${cashSales.toLocaleString()}`;
            document.getElementById('detail-cash-profit').textContent = `¥${cashProfit.toLocaleString()}`;
            document.getElementById('detail-paypay-sales').textContent = `¥${paypaySales.toLocaleString()}`;
            document.getElementById('detail-paypay-profit').textContent = `¥${paypayProfit.toLocaleString()}`;
            document.getElementById('detail-total-sales').textContent = `¥${totalSales.toLocaleString()}`;
            document.getElementById('detail-total-profit').textContent = `¥${totalProfit.toLocaleString()}`;

            renderSalesChart(data.hourly || {}); // グラフのデータ更新関数を呼び出す
        }
    });
    </script>
</body>
</html>